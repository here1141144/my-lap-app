<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Auto-Lap Tracker</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        #lap-container {
            text-align: center;
        }

        #lap-label {
            font-size: 1.5rem;
            color: #00ff88;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #lap-count {
            font-size: 10rem;
            font-weight: 900;
            line-height: 1;
            margin: 10px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 80%;
            margin-top: 20px;
            text-align: center;
        }

        .stat-box {
            background: #111;
            padding: 15px;
            border-radius: 15px;
            border: 1px solid #333;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
        }

        #start-btn {
            margin-top: 40px;
            padding: 20px 60px;
            font-size: 1.5rem;
            font-weight: bold;
            border-radius: 50px;
            border: none;
            background: #00ff88;
            color: #000;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        #start-btn.active {
            background: #ff4444;
            color: #fff;
        }

        /* Background Hack: Hidden Video */
        #silent-video {
            position: absolute;
            width: 1px;
            height: 1px;
            opacity: 0.01;
        }

        #status-indicator {
            position: fixed;
            top: 20px;
            font-size: 0.7rem;
            color: #555;
        }
    </style>
</head>
<body>

    <div id="status-indicator">Waiting for Start...</div>

    <div id="lap-container">
        <div id="lap-label">Lap</div>
        <div id="lap-count">0</div>
    </div>

    <div class="stats-grid">
        <div class="stat-box">
            <span class="stat-value" id="timer">00:00</span>
            <span class="stat-label">Total Time</span>
        </div>
        <div class="stat-box">
            <span class="stat-value" id="distance">0m</span>
            <span class="stat-label">From Start</span>
        </div>
    </div>

    <button id="start-btn">START TRACKING</button>

    <video id="silent-video" loop playsinline muted>
        <source src="https://github.com/anars/blank-audio/raw/master/10-seconds-of-silence.mp3" type="audio/mp3">
    </video>

    <script>
        let lapCount = 0;
        let anchorPoint = null;
        let isTracking = false;
        let hasLeftGate = false;
        let startTime = null;
        let timerInterval = null;
        let wakeLock = null;

        const lapDisplay = document.getElementById('lap-count');
        const timerDisplay = document.getElementById('timer');
        const distanceDisplay = document.getElementById('distance');
        const startBtn = document.getElementById('start-btn');
        const status = document.getElementById('status-indicator');
        const video = document.getElementById('silent-video');

        // Settings
        const GATE_RADIUS = 10; // Meters to trigger lap
        const COOLDOWN_DIST = 25; // Meters to reset trigger

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function startApp() {
            if (!isTracking) {
                // Initializing
                isTracking = true;
                startBtn.textContent = "STOP";
                startBtn.classList.add('active');
                startTime = Date.now();
                
                // Start Hacks
                video.play();
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                } catch (err) {}

                // Get Anchor Point
                navigator.geolocation.getCurrentPosition((pos) => {
                    anchorPoint = pos.coords;
                    status.textContent = "Anchor Set. Move 50m away.";
                });

                // Start Timers/Tracking
                timerInterval = setInterval(updateUI, 1000);
                navigator.geolocation.watchPosition(checkLocation, null, {
                    enableHighAccuracy: true
                });
            } else {
                location.reload(); // Simple reset
            }
        }

        function checkLocation(pos) {
            if (!anchorPoint) return;

            const dist = calculateDistance(
                pos.coords.latitude, pos.coords.longitude,
                anchorPoint.latitude, anchorPoint.longitude
            );

            distanceDisplay.textContent = Math.round(dist) + "m";

            // Cooldown Logic
            if (dist > COOLDOWN_DIST) {
                hasLeftGate = true;
                status.textContent = "Gate Armed: Return to Start";
            }

            // Lap Trigger Logic
            if (hasLeftGate && dist < GATE_RADIUS) {
                lapCount++;
                lapDisplay.textContent = lapCount;
                hasLeftGate = false; // Reset cooldown
                status.textContent = "Lap Detected! Move 50m away.";
                
                // Feedback
                window.navigator.vibrate([200, 100, 200]);
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                osc.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        function updateUI() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const secs = (elapsed % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${mins}:${secs}`;
        }

        startBtn.addEventListener('click', startApp);
    </script>
</body>
</html>
