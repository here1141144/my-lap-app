<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Lap Tracker v7</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* DASHBOARD STYLING */
        body { background: #111; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        
        /* SETUP SCREEN */
        #setup-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        input { background: #333; border: 1px solid #555; color: #fff; padding: 15px; border-radius: 10px; font-size: 1.2rem; margin-bottom: 15px; width: 80%; text-align: center; }
        label { color: #00ff88; margin-bottom: 5px; font-size: 0.9rem; font-weight: bold; }
        
        #capture-area { background: #1a1a1a; width: 100%; display: flex; flex-direction: column; align-items: center; padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #333; }
        
        /* GOAL BAR */
        #goal-bar-container { width: 100%; background: #333; height: 8px; border-radius: 4px; margin: 5px 0 15px 0; overflow: hidden; }
        #goal-bar-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #ff8800, #ff4444); transition: width 0.5s; }
        #goal-text { font-size: 0.7rem; color: #ff8800; display: block; width: 100%; text-align: left; }

        /* BIG METRICS */
        #lap-container { display: flex; align-items: baseline; gap: 10px; margin-bottom: 10px; }
        #lap-count { font-size: 5rem; font-weight: 900; color: #fff; line-height: 1; }
        .lap-label { font-size: 1rem; color: #888; font-weight: bold; }
        
        /* 3x3 GRID FOR ALL METRICS */
        .stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; width: 100%; }
        .box { background: #2a2a2a; padding: 8px; border-radius: 8px; text-align: center; border: 1px solid #444; display: flex; flex-direction: column; justify-content: center; min-height: 60px; }
        
        .val { font-size: 1rem; font-weight: bold; color: #fff; }
        .lbl { font-size: 0.6rem; color: #aaa; text-transform: uppercase; margin-top: 2px; }
        
        /* COLOR CODING */
        #cals { color: #ff8800; }
        #laps-togo { color: #ff4444; }
        #water { color: #00ccff; }
        #steps { color: #00ff88; }

        #map { height: 220px; width: 100%; border-radius: 15px; margin-top: 15px; border: 2px solid #444; }
        
        .btns { display: flex; gap: 10px; width: 100%; justify-content: center; margin-bottom: 20px; }
        button { padding: 15px 30px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; }
        #start-btn { background: #00ff88; color: #000; flex: 2; }
        #save-img-btn { background: #444; color: #fff; flex: 1; }
        
        #history { width: 95%; padding-bottom: 40px; }
        .history-item { background: #222; padding: 10px; margin-bottom: 8px; border-radius: 8px; font-size: 0.75rem; display: flex; justify-content: space-between; border-left: 3px solid #00ff88; }

        /* HIDDEN WAKE LOCK */
        #silent-video { position: absolute; width: 1px; height: 1px; opacity: 0.01; pointer-events: none; }
        #status-msg { font-size: 0.7rem; color: #666; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h2 style="color:#fff; margin-bottom: 30px;">WORKOUT SETUP</h2>
        <label>Your Weight (kg)</label>
        <input type="number" id="user-weight" placeholder="e.g. 75" value="70">
        <label>Calorie Goal (kcal)</label>
        <input type="number" id="user-goal" placeholder="e.g. 300" value="300">
        <button id="confirm-setup-btn" style="background:#00ff88; color:#000; width:80%;">GO TO DASHBOARD</button>
    </div>

    <div id="capture-area">
        <div id="status-msg">Ready to Start</div>
        
        <span id="goal-text">Goal Progress: 0%</span>
        <div id="goal-bar-container"><div id="goal-bar-fill"></div></div>

        <div id="lap-container">
            <div id="lap-count">0</div>
            <div class="lap-label">LAPS</div>
        </div>
        
        <div class="stats">
            <div class="box"><span class="val" id="cals">0</span><span class="lbl">Kcal Burn</span></div>
            <div class="box"><span class="val" id="laps-togo">--</span><span class="lbl">Laps Left</span></div>
            <div class="box"><span class="val" id="water">0ml</span><span class="lbl">Hydration</span></div>
            
            <div class="box"><span class="val" id="timer">00:00</span><span class="lbl">Duration</span></div>
            <div class="box"><span class="val" id="pace">--</span><span class="lbl">Min/Km</span></div>
            <div class="box"><span class="val" id="total-dist">0.00</span><span class="lbl">Total Km</span></div>

            <div class="box"><span class="val" id="steps">0</span><span class="lbl">Steps</span></div>
            <div class="box"><span class="val" id="acc">--</span><span class="lbl">GPS Acc</span></div>
            <div class="box"><span class="val" id="best">--</span><span class="lbl">Best Lap</span></div>
        </div>

        <div id="map"></div>
    </div>

    <div class="btns">
        <button id="start-btn">START</button>
        <button id="save-img-btn">ðŸ“¸ SAVE</button>
    </div>

    <div id="history">
        <h3 style="font-size:0.8rem; border-bottom:1px solid #444; color:#aaa;">HISTORY</h3>
        <div id="history-list"></div>
    </div>

    <video id="silent-video" loop playsinline muted>
        <source src="https://github.com/anars/blank-audio/raw/master/10-seconds-of-silence.mp3" type="audio/mp3">
    </video>

    <script>
        // --- CONSTANTS ---
        const GATE_RADIUS = 5;      
        const COOLDOWN_DIST = 35;   
        const ACCURACY_LIMIT = 20;  
        const STEP_SENSITIVITY = 12;

        // --- VARIABLES ---
        let userWeight = 70, calorieGoal = 300;
        let laps = 0, steps = 0, isRunning = false, anchor = null, hasLeft = false;
        let startTime = null, lapStartTime = null, bestLap = Infinity;
        let totalDistanceMeters = 0, previousGPS = null, lastZ = 0;
        let pathCoords = [], wakeLock = null;
        let history = JSON.parse(localStorage.getItem('ultimate_history') || '[]');

        // --- MAP SETUP ---
        let map = L.map('map', { zoomControl: false }).setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
        let polyline = L.polyline([], {color: '#ff8800', weight: 5}).addTo(map);
        let userMarker = L.marker([0,0]).addTo(map);

        const statusMsg = document.getElementById('status-msg');
        const video = document.getElementById('silent-video');

        // Setup Screen Logic
        document.getElementById('confirm-setup-btn').addEventListener('click', () => {
            const w = document.getElementById('user-weight').value;
            const g = document.getElementById('user-goal').value;
            if(w && g) {
                userWeight = parseFloat(w);
                calorieGoal = parseFloat(g);
                document.getElementById('setup-screen').style.display = 'none';
            }
        });

        renderHistory();

        // --- START TRACKING ---
        async function startTracking() {
            if (isRunning) { saveSession(); location.reload(); return; }
            
            // 1. Wake Lock
            try { video.play(); if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
            
            // 2. Motion Permissions (Steps)
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                try { await DeviceMotionEvent.requestPermission(); } catch (e) {}
            }

            isRunning = true;
            startTime = Date.now();
            lapStartTime = Date.now();
            document.getElementById('start-btn').textContent = "FINISH";
            document.getElementById('start-btn').style.background = "#ff4444";
            statusMsg.textContent = "Setting Anchor... Stand Still.";

            window.addEventListener('devicemotion', countSteps); // Re-added Steps!
            setInterval(updateTimerAndHealth, 1000); // Re-added Timer/Health loop
            navigator.geolocation.watchPosition(handleGPS, null, { enableHighAccuracy: true });
        }

        // --- METRICS LOOP (Time, Pace, Calories, Water) ---
        function updateTimerAndHealth() {
            if(!isRunning) return;
            
            // Timer
            let elapsedSecs = Math.floor((Date.now() - startTime) / 1000);
            let mins = Math.floor(elapsedSecs/60).toString().padStart(2,'0');
            let secs = (elapsedSecs%60).toString().padStart(2,'0');
            document.getElementById('timer').textContent = `${mins}:${secs}`;
            
            // Pace (Min/Km)
            let totalKm = totalDistanceMeters / 1000;
            if(totalKm > 0.05) {
                let p = (elapsedSecs / 60) / totalKm;
                document.getElementById('pace').textContent = p.toFixed(2);
            }

            // Calories (Weight * Dist * Factor)
            let cals = totalKm * userWeight * 1.036;
            document.getElementById('cals').textContent = Math.round(cals);
            
            // Goal Bar
            let percent = Math.min(100, (cals / calorieGoal) * 100);
            document.getElementById('goal-bar-fill').style.width = percent + "%";
            document.getElementById('goal-text').textContent = `Goal: ${Math.round(percent)}%`;

            // Laps To Go
            if (laps > 0 && cals > 1) {
                let calsPerLap = cals / laps;
                let calsRem = calorieGoal - cals;
                let lapsLeft = calsRem > 0 ? Math.ceil(calsRem / calsPerLap) : 0;
                document.getElementById('laps-togo').textContent = lapsLeft > 0 ? lapsLeft : "DONE!";
            }

            // Water (12ml per min)
            document.getElementById('water').textContent = Math.round((elapsedSecs/60) * 12) + "ml";
        }

        // --- STEP COUNTER ---
        function countSteps(e) {
            let z = e.accelerationIncludingGravity.z;
            if (Math.abs(z - lastZ) > STEP_SENSITIVITY) {
                steps++; 
                document.getElementById('steps').textContent = steps;
            }
            lastZ = z;
        }

        // --- GPS LOGIC ---
        function handleGPS(pos) {
            const { latitude, longitude, accuracy } = pos.coords;
            document.getElementById('acc').textContent = Math.round(accuracy) + "m";
            userMarker.setLatLng([latitude, longitude]);

            if (!anchor && accuracy < 25) {
                anchor = pos.coords;
                previousGPS = { lat: latitude, lng: longitude };
                map.setView([latitude, longitude], 18);
                statusMsg.textContent = "GO! Run away from start.";
                L.circle([latitude, longitude], {radius: GATE_RADIUS, color: 'red', fillOpacity: 0.2}).addTo(map);
            }
            if (!anchor) return;

            // Distance
            let stepDist = calcDist(latitude, longitude, previousGPS.lat, previousGPS.lng);
            if (stepDist > 2) {
                totalDistanceMeters += stepDist;
                previousGPS = { lat: latitude, lng: longitude };
                document.getElementById('total-dist').textContent = (totalDistanceMeters / 1000).toFixed(2);
                pathCoords.push([latitude, longitude]);
                polyline.setLatLngs(pathCoords);
            }

            // Lap Logic
            let distFromAnchor = calcDist(latitude, longitude, anchor.latitude, anchor.longitude);
            if (distFromAnchor > COOLDOWN_DIST) { hasLeft = true; statusMsg.textContent = "Turn back..."; }
            
            if (hasLeft && distFromAnchor < GATE_RADIUS && accuracy < ACCURACY_LIMIT) {
                laps++;
                document.getElementById('lap-count').textContent = laps;
                
                // Best Lap
                let lapTime = (Date.now() - lapStartTime) / 1000;
                if (lapTime < bestLap) {
                    bestLap = lapTime;
                    document.getElementById('best').textContent = lapTime.toFixed(1) + "s";
                }
                lapStartTime = Date.now();
                hasLeft = false;
                statusMsg.textContent = "Lap Complete!";
                window.navigator.vibrate(200);
            }
        }

        function calcDist(lat1, lon1, lat2, lon2) {
            const R = 6371e3; const p = Math.PI/180;
            const a = 0.5 - Math.cos((lat2-lat1)*p)/2 + Math.cos(lat1*p)*Math.cos(lat2*p)*(1-Math.cos((lon2-lon1)*p))/2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        // --- SAVE HISTORY ---
        function saveSession() {
            history.push({
                date: new Date().toLocaleDateString(),
                laps: laps,
                steps: steps,
                cals: document.getElementById('cals').textContent,
                dist: document.getElementById('total-dist').textContent
            });
            localStorage.setItem('ultimate_history', JSON.stringify(history));
        }

        function renderHistory() {
            document.getElementById('history-list').innerHTML = history.slice().reverse().map(run => `
                <div class="history-item">
                    <span>${run.date}</span>
                    <span><b>${run.cals} Kcal</b> â€¢ ${run.laps} Laps â€¢ ${run.steps} Steps</span>
                </div>
            `).join('');
        }

        document.getElementById('save-img-btn').addEventListener('click', () => {
            html2canvas(document.querySelector("#capture-area"), { backgroundColor: "#1a1a1a" }).then(canvas => {
                let link = document.createElement('a');
                link.download = 'workout.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        });

        document.getElementById('start-btn').addEventListener('click', startTracking);
    </script>
</body>
</html>
